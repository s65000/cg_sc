<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì—…ë¬´ ìŠ¤ì¼€ì¤„ëŸ¬ (ì£¼ë§/ê³µíœ´ì¼ ì œì™¸ + ë‹¬ë ¥/ì›”ë³„/ë³´ë¥˜) â€” GAS ì €ì¥</title>
<script>
/* ========= TEST ëª¨ë“œ ìŠ¤ìœ„ì¹˜ (ê¸°ë³¸: êº¼ì§) ========= */
window.__TEST_MODE__ = false;    // í…ŒìŠ¤íŠ¸ íŒ¨ë„ì—ì„œë§Œ trueë¡œ ë°”ê¿ˆ
// window.__FORCE_TODAY__ = 'YYYY-MM-DD' // í…ŒìŠ¤íŠ¸ íŒ¨ë„ì´ ì„¤ì •/í•´ì œ

/* ========= ê³µìš© ì„ íƒì ========= */
const $ = (sel)=>document.querySelector(sel);

/* ========= ìƒíƒœ í‘œì‹œ ========= */
function setStatus(txt){ const el = $('#statusLine'); if(el) el.textContent = txt; }

/* =========================
 * ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°(GAS ë˜ëŠ” ë¡œì»¬)
 * ========================= */
const __read_ONLY__ = false;
const CAN_EDIT = true;

function hasGAS(){ return !!(window.google && google.script && google.script.run); }

function saveData(data){
  if(hasGAS()){
    google.script.run.withSuccessHandler(function(){ setStatus("ì €ì¥ ì„±ê³µ (ì„œë²„)"); }).saveData(data);
  } else {
    console.log("ë¡œì»¬ ì‹¤í–‰:", data);
    setStatus("ì €ì¥ì€ ë¡œì»¬ì—ì„œë§Œ í…ŒìŠ¤íŠ¸ë¨ (ì„œë²„ ì•„ë‹˜)");
  }
}

function jsonbinGet(){
  return new Promise((resolve)=>{
    if (hasGAS()){
      google.script.run.withSuccessHandler((data)=> resolve(data || {}))
                       .withFailureHandler(()=> resolve({})).getData();
    } else {
      try{
        const raw = localStorage.getItem("sched:server-dump");
        resolve(raw ? JSON.parse(raw) : {});
      }catch{ resolve({}); }
    }
  });
}

function jsonbinPut(payload){
  return new Promise((resolve, reject)=>{
    if (hasGAS()){
      google.script.run.withSuccessHandler((res)=> resolve(res || {ok:true}))
                       .withFailureHandler((err)=> reject(err)).putData(payload);
    } else {
      try{
        localStorage.setItem("sched:server-dump", JSON.stringify(payload));
        resolve({ok:true, local:true});
      }catch(e){ reject(e); }
    }
  });
}

/* =========================
 * ë·°í¬íŠ¸ ì²´í¬
 * ========================= */
const MOBILE_BREAKPOINT = 1100;
function isMobileView() {
  const w = Math.min(window.innerWidth || 9999, document.documentElement.clientWidth || 9999);
  const ua = navigator.userAgent || "";
  const isUAmm = /Android|iPhone|iPad|iPod|Mobile/i.test(ua);
  return (w <= MOBILE_BREAKPOINT) || isUAmm;
}

/* =========================
 * ë¹„ë°€ë²ˆí˜¸(í¸ì§‘ ì ê¸ˆ)
 * ========================= */
const PASS_VALUE = '1234';
let PASS_OK = false;
const canEdit = () => CAN_EDIT && PASS_OK;

/* =========================
 * ìœ í‹¸/ì˜ì—…ì¼ ê³„ì‚°
 * ========================= */
const uid = ()=> 'id-'+Math.random().toString(36).slice(2,9);

// ë‚ ì§œ í¬ë§·
function toISO(d){
  let x;
  if (d instanceof Date){
    x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  } else if (typeof d === 'string'){
    const [y,m,dd] = d.split('-').map(Number);
    x = new Date(y, (m||1)-1, dd||1);
  } else {
    x = new Date(d);
    x = new Date(x.getFullYear(), x.getMonth(), x.getDate());
  }
  const y = x.getFullYear();
  const m = String(x.getMonth()+1).padStart(2,'0');
  const dd = String(x.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
function parseISO(s){ const [y,m,d]=s.split('-').map(Number); const dt = new Date(y, m-1, d); dt.setHours(0,0,0,0); return dt; }
function esc(s){
  return (s==null ? '' : String(s)).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

// âœ… ì‹¤ì œ ì˜¤ëŠ˜(í•­ìƒ ì‹œìŠ¤í…œ ì‹œê°„)
function getRealTodayDate(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
function getRealTodayISO(){ return toISO(getRealTodayDate()); }

// âœ… í™”ë©´Â·ì—”ì§„ì—ì„œ ì“°ëŠ” "ì˜¤ëŠ˜" (TEST ëª¨ë“œì¼ ë•Œë§Œ ê°•ì œê°’ ì‚¬ìš©)
function getTodayDate(){
  if (window.__TEST_MODE__ &&
      typeof window.__FORCE_TODAY__ === 'string' &&
      /^\d{4}-\d{2}-\d{2}$/.test(window.__FORCE_TODAY__)){
    return parseISO(window.__FORCE_TODAY__);
  }
  return getRealTodayDate();
}
function getTodayISO(){ return toISO(getTodayDate()); }

function viewTodayISO(){
  const t = window.__TEST_TODAY__;
  return (typeof t === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(t)) ? t : getTodayISO();
}


// ê¸°ì¤€ì¼ì„ "ì‹¤ì œ ì˜¤ëŠ˜"ë¡œ ë³´ì • (í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì˜í–¥ âŒ)
function ensureBaselineToday(owner){
  if(!owner) return;
  const today = getRealTodayISO();
  if (!state.startByOwner) state.startByOwner = {};
  if (state.startByOwner[owner] !== today){
    state.startByOwner[owner] = today;
    localStorage.setItem('sched:startByOwner', JSON.stringify(state.startByOwner));
  }
}

const KR_2025 = new Set(['2025-01-01','2025-02-10','2025-02-11','2025-03-01','2025-05-05','2025-06-06','2025-08-15','2025-09-17','2025-09-18','2025-10-03','2025-10-09','2025-12-25']);
const isWeekend = (d)=>{ const day = d.getDay(); return day===0 || day===6; };
const isHoliday = (d)=> KR_2025.has(toISO(d));
const isBiz = (d)=> !isWeekend(d) && !isHoliday(d);
const bumpToBiz = (day)=>{ while(!isBiz(day)) day.setDate(day.getDate()+1); };
function addBizDays(date, days){
  const d = (date instanceof Date) ? new Date(date) : parseISO(String(date));
  let left = Math.max(0, Math.floor(days));
  while(left>0){ d.setDate(d.getDate()+1); if(isBiz(d)) left--; }
  d.setHours(0,0,0,0);
  return d;
}
function bizDaysBetween(startDate, endDate){
  if(!startDate || !endDate) return 0;
  const s = (startDate instanceof Date) ? new Date(startDate) : parseISO(String(startDate));
  const e = (endDate   instanceof Date) ? new Date(endDate)   : parseISO(String(endDate));
  s.setHours(0,0,0,0); e.setHours(0,0,0,0);
  if(e < s) return 0;
  let cnt = 0; const cur = new Date(s);
  while(cur <= e){ if(isBiz(cur)) cnt++; cur.setDate(cur.getDate()+1); }
  return cnt;
}
function debounce(fn, wait=200){ let t=null; return (...a)=>{ if(t)clearTimeout(t); t=setTimeout(()=>fn(...a),wait); }; }
const isSimple = (t)=> (t.workType||'NEW') === 'ê°„ë‹¨ìˆ˜ì •';

/* í”„ë¡œì íŠ¸ ìƒ‰ìƒ */
const PROJECT_COLORS = ["#fca5a5","#fdba74","#fcd34d","#bef264","#86efac","#93c5fd","#a5b4fc","#c4b5fd","#f9a8d4","#fda4af","#67e8f9","#5eead4"];
function getProjectColor(id){ if(!id) return "#9ca3af"; let h=0; for(let i=0;i<id.length;i++) h=(h*31+id.charCodeAt(i))>>>0; return PROJECT_COLORS[h%PROJECT_COLORS.length]; }
function getContrastText(hex){
  const c=hex.replace('#','');
  const r=parseInt(c.length===3?c[0]+c[0]:c.slice(0,2),16);
  const g=parseInt(c.length===3?c[1]+c[1]:c.slice(2,4),16);
  const b=parseInt(c.length===3?c[2]+c[2]:c.slice(4,6),16);
  const yiq=(r*299+g*587+b*114)/1000;
  return yiq>=150?"#111827":"#ffffff";
}

/* í•˜ìœ„ id ìˆ˜ì§‘ */
function collectDescendantIds(tasks, rootId){
  const ids = new Set([rootId]); let changed = true;
  while (changed){
    changed = false;
    for (const t of tasks){
      if (t.group && ids.has(t.group) && !ids.has(t.id)){ ids.add(t.id); changed = true; }
    }
  }
  return ids;
}

/* ì‘ì—… ì‹œì‘ ëª¨ë‹¬ */
function openScheduleDialog(defaults){
  return new Promise((resolve, reject)=>{
    const startISO = defaults?.startISO || getTodayISO();
    const duration = Number.isFinite(defaults?.duration) ? defaults.duration : 1;
    const host = $('#modalHost');
    host.innerHTML = `
      <div class="modal-overlay" role="dialog" aria-modal="true">
        <div class="modal">
          <h3>ì‘ì—… ì‹œì‘ ì¼ì •</h3>
          <div class="modal-body">
            <label>ì‹œì‘ì¼ <input type="date" id="mdStart" value="${startISO}"></label>
            <label>ê¸°ê°„(ì˜ì—…ì¼) <input type="number" id="mdDur" min="1" value="${duration}"></label>
          </div>
          <div class="modal-actions">
            <button class="btn" id="mdCancel">ì·¨ì†Œ</button>
            <button class="btn primary" id="mdOk">í™•ì¸</button>
          </div>
        </div>
      </div>`;
    const onClose = ()=>{ host.innerHTML = ''; };
    host.querySelector('#mdCancel').addEventListener('click', ()=>{ onClose(); reject(new Error('cancel')); }, {passive:true});
    host.querySelector('#mdOk').addEventListener('click', ()=>{ 
      const s = host.querySelector('#mdStart').value || getTodayISO();
      let d = parseInt(host.querySelector('#mdDur').value,10);
      if(!(d>0)) d = 1;
      onClose(); resolve({ startISO: s, duration: d });
    }, {passive:true});
    host.querySelector('.modal-overlay').addEventListener('click', (e)=>{ if(e.target.classList.contains('modal-overlay')){ onClose(); reject(new Error('cancel')); }});
    document.addEventListener('keydown', function onEsc(ev){ if(ev.key==='Escape'){ document.removeEventListener('keydown', onEsc); onClose(); reject(new Error('cancel')); } }, { once:true });
  });
}

/* =========================
 * ì „ì—­ ìƒíƒœ
 * ========================= */
let lastSavedJSON = '';
let __todayCache = getTodayISO();
setInterval(()=>{ const now=getTodayISO(); if(now!==__todayCache){ __todayCache=now; renderAll(); } }, 60*1000);

const state = {
  owners: JSON.parse(localStorage.getItem('sched:owners')||'[]'),
  owner: localStorage.getItem('sched:owner') || (()=>{ const owners = JSON.parse(localStorage.getItem('sched:owners')||'[]'); return owners.length > 0 ? owners[0] : ''; })(),
  startByOwner: (()=>{ try{ const raw = localStorage.getItem('sched:startByOwner'); if(raw) return JSON.parse(raw); return {}; }catch{ return {}; } })(),
  tasks: (()=>{ 
    try{
      const raw = localStorage.getItem('sched:tasks'); if(!raw) return [];
      const arr = JSON.parse(raw);
      return (Array.isArray(arr)?arr:[]).map(t=>{
        const workType = t.workType || (t.parallel ? 'ê°„ë‹¨ìˆ˜ì •' : 'NEW');
        return {
          id: t.id || uid(),
          owner: t.owner || '',
          name: t.name || 'Untitled',
          duration: (t.duration>0?t.duration:1),
          extraDays: Number.isFinite(t.extraDays)? t.extraDays : 0,
          pd: t.pd || '',
          workType,
          parallel: workType==='ê°„ë‹¨ìˆ˜ì •',
          group: (workType==='ê°„ë‹¨ìˆ˜ì •') ? (t.group || null) : null,
          planned: !!t.planned,
          inProgress: !!t.inProgress,
          completed: !!t.completed,
          startedAt: t.startedAt || null,
          completedAt: t.completedAt || null,
          spentDays: Number.isFinite(t.spentDays) ? t.spentDays : 0,
          activeSinceISO: t.activeSinceISO || null
        };
      });
    }catch{ return []; } 
  })(),
  reports: (()=>{ try{ const raw = localStorage.getItem('sched:reports'); const arr = raw? JSON.parse(raw) : []; return Array.isArray(arr)? arr : []; }catch{ return []; } })(),
  holds:   (()=>{ try{ const raw = localStorage.getItem('sched:holds');   const arr = raw? JSON.parse(raw) : []; return Array.isArray(arr)? arr : []; }catch{ return []; } })(),
  reportTabKey: (new Date().getMonth()+1).toString()
};

function buildPayload(){ return { owners: state.owners, startByOwner: state.startByOwner, tasks: state.tasks, reports: state.reports, holds: state.holds }; }

const saveNow = async ()=>{
  try{
    if(!CAN_EDIT){ setStatus('ì½ê¸° ì „ìš©(ì €ì¥ ë¶ˆê°€)'); return; }
    const payload = buildPayload();
    const cur = JSON.stringify(payload);
    if(cur===lastSavedJSON){ setStatus('ë³€ê²½ ì—†ìŒ'); return; }
    setStatus('ì €ì¥ ì¤‘â€¦'); await jsonbinPut(payload);
    lastSavedJSON = cur;
    localStorage.setItem('sched:owners', JSON.stringify(state.owners));
    localStorage.setItem('sched:owner', state.owner);
    localStorage.setItem('sched:startByOwner', JSON.stringify(state.startByOwner));
    localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
    localStorage.setItem('sched:reports', JSON.stringify(state.reports));
    localStorage.setItem('sched:holds', JSON.stringify(state.holds));
    setStatus('ì €ì¥ë¨');
  }catch(e){ console.error(e); setStatus('ì €ì¥ ì‹¤íŒ¨'); }
};

const saveNowAuto = debounce(async ()=>{
  try{
    const payload = buildPayload();
    const cur = JSON.stringify(payload);
    if(cur===lastSavedJSON) return;
    localStorage.setItem('sched:owners', JSON.stringify(state.owners));
    localStorage.setItem('sched:owner', state.owner);
    localStorage.setItem('sched:startByOwner', JSON.stringify(state.startByOwner));
    localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
    localStorage.setItem('sched:reports', JSON.stringify(state.reports));
    localStorage.setItem('sched:holds', JSON.stringify(state.holds));
    if(CAN_EDIT){
      setStatus('ìë™ ì €ì¥ ì¤‘â€¦'); await jsonbinPut(payload);
      lastSavedJSON = cur; setStatus('ì €ì¥ë¨');
    }else{ setStatus('ì˜¤í”„ë¼ì¸: ë¡œì»¬ ì €ì¥ë¨'); }
  }catch(e){ console.warn(e); setStatus('ìë™ ì €ì¥ ì‹¤íŒ¨'); }
}, 200);

/* =========================
 * ì§„í–‰/ì”ì—¬ ê³„ì‚°
 * ========================= */
let __lastTopId = null;
function syncTopProgress(newTopId){ __lastTopId = newTopId || null; }

function effectiveDuration(t){
  const total = (t.duration || 0) + (t.extraDays || 0);
  let progress = 0;
  if (!t.planned && !t.completed && t.startedAt) {
    const s = parseISO(t.startedAt);
    const e = parseISO(viewTodayISO()); // TEST ëª¨ë“œì¼ ë•ŒëŠ” ê°€ì§œ ì˜¤ëŠ˜ë¡œ ì§„í–‰ë¥  ì‹œë®¬
    progress = Math.min(total, Math.max(0, bizDaysBetween(s, e)));
  }
  const remain = Math.max(0, total - progress);
  return { total, progress, remain };
}

// ìŠ¤ì¼€ì¤„ ì‚°ì¶œ + ì§€ì—° ì²˜ë¦¬ (ì™„ë£Œì¼ ë‹¹ì¼ ê¸ˆì§€ + ë°°ì •ë¸”ë¡ ê³ ì •)
function computeSchedule(tasks, startISO, activeTopId){
  let cursor = parseISO(startISO);
  bumpToBiz(cursor);

  // âœ… ì™„ë£Œì¼ ë‹¹ì¼ì—ëŠ” ì–´ë–¤ ì‘ì—…ë„ ì‹œì‘í•˜ì§€ ì•Šê²Œ ê°•ì œ
  const cdISO = state.cooldownByOwner?.[state.owner];
  if (cdISO){
    const cd = parseISO(cdISO);  // (ë‹¤ìŒ ì˜ì—…ì¼)
    if (cursor < cd) cursor = new Date(cd);
  }

  const planned = [];
  const byId = new Map();

  for (const t of tasks){
    // ìì‹(ê°„ë‹¨ìˆ˜ì •)ì€ ë¶€ëª¨ ë¸”ë¡ ê·¸ëŒ€ë¡œ ë”°ë¼ê°
    const hasValidAnchor = !!(t.group && byId.get(t.group));
    if (hasValidAnchor){
      const anchor = byId.get(t.group);
      const start = new Date(anchor.start);
      const end   = new Date(anchor.end);
      const meta  = (isSimple(t) ? {...anchor.meta, mirrorsParent:true} : anchor.meta);
      const row = {...t, start, end, meta};
      planned.push(row);
      byId.set(t.id, row);
      continue;
    }

    bumpToBiz(cursor);
    const start = new Date(cursor);

    const isTop = t.id === activeTopId;
    const meta  = effectiveDuration(t);

    const todayD = parseISO(viewTodayISO());
    const expectedEnd = addBizDays(start, Math.max(0, (meta.total||0) - 1));

    // âœ… ê¸°ë³¸ì€ í•­ìƒ 'ë°°ì • ì¢…ë£Œì¼' ê³ ì •
    let end = expectedEnd;
    let overdueDays = 0;

    // âœ… ë°°ì • ì´ˆê³¼ ì‹œì—ë§Œ, ì˜¤ëŠ˜ê¹Œì§€ ë’¤ë¡œ ëŠ˜ë ¤ì„œ 'ë°€ë¦¼'
    if (isTop && !t.completed && !t.planned && (todayD > expectedEnd)){
      overdueDays = bizDaysBetween(addBizDays(expectedEnd, 1), todayD);
      end = new Date(todayD);
    }

    const nextStart = addBizDays(end, 1);

    const row = {...t, start, end, meta:{...meta, expectedEnd, overdueDays}};
    planned.push(row);
    byId.set(t.id, row);
    cursor = new Date(nextStart);
  }

  return planned;
}



function finishTaskBlockAndReschedule(taskLike, completedISO){
  const parent = state.tasks.find(x=>x.id===taskLike.id);
  if(!parent) return;

  // ë¶€ëª¨+ìì‹ ë¬¶ìŒ
  const ids   = collectDescendantIds(state.tasks, parent.id);
  const block = state.tasks.filter(x=> ids.has(x.id));

  // ì™„ë£Œ ê¸°ì¤€ì¼: ì „ë‹¬ê°’ > í…ŒìŠ¤íŠ¸ ì˜¤ëŠ˜ > ì‹¤ì œ ì˜¤ëŠ˜
  const todayISO = completedISO || viewTodayISO();
  const todayD   = parseISO(todayISO);

  // === ì™„ë£Œ ì§ì „ì˜ ìŠ¤ì¼€ì¤„ì„ "í˜„ì¬ ê¸°ì¤€"ìœ¼ë¡œ ë‹¤ì‹œ ê³„ì‚°í•´ì„œ,
  //     í•´ë‹¹ parent rowì˜ meta.total / meta.overdueDaysë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© ===
  const startBase = state.startByOwner[state.owner] || viewTodayISO();
  const visible   = state.tasks.filter(t=> t.owner === state.owner);
  const firstActiveMain = visible.find(t=> !t.group && !t.completed && !t.planned);
  const progressingId   = firstActiveMain ? firstActiveMain.id : null;
  const plannedNow      = computeSchedule(visible, startBase, progressingId);

  const parentRow = plannedNow.find(p => p.id === parent.id);
  // ì•ˆì „ì¥ì¹˜: ëª» ì°¾ìœ¼ë©´ ì§ì ‘ ì¬ê³„ì‚°
  const plannedTotalParent = parentRow?.meta?.total ?? ((parent.duration||0)+(parent.extraDays||0));
  const overdueParent      = parentRow?.meta?.overdueDays ?? (()=>{
    const startISO = parent.startedAt || startBase;
    const expEnd   = addBizDays(parseISO(startISO), Math.max(0, plannedTotalParent-1));
    return Math.max(0, bizDaysBetween(addBizDays(expEnd,1), todayD));
  })();

  // --- ë¦¬í¬íŠ¸ ê¸°ë¡ (ë¶€ëª¨=ì‹¤ì‚¬ìš©ì¼, ìì‹=ë°°ì •ì¼, ê°„ë‹¨ìˆ˜ì •=ë¬¸ì) ---
block.forEach(it => {
  // 1) ê°„ë‹¨ìˆ˜ì •ì€ ìˆ«ì ëŒ€ì‹  í…ìŠ¤íŠ¸
  if (it.workType === 'ê°„ë‹¨ìˆ˜ì •') {
    state.reports.push({
      id: uid(),
      owner: it.owner,
      name: it.name,
      pd: it.pd || '',
      usedDays: 'ê°„ë‹¨ìˆ˜ì •',
      month: (todayD.getMonth() + 1),
      completedAt: todayISO
    });
    return;
  }

  // 2) ë¶€ëª¨(ì„ í–‰)ë§Œ â€œì‹¤ì‚¬ìš©ì¼(ì˜ì—…ì¼)â€ë¡œ ê¸°ë¡ => ì˜¤ë²„(+)/ì–¸ë”(-) ìë™ ë°˜ì˜
  if (it.id === parent.id) {
    const parentRow = plannedNow.find(p => p.id === it.id);

    // ì‹¤ì œ ì‹œì‘ anchor: activeSinceISO > startedAt > (í”Œëœëœ start) ìˆœìœ¼ë¡œ ì‹ ë¢°
    const startAnchor =
      it.activeSinceISO ? parseISO(it.activeSinceISO)
      : it.startedAt    ? parseISO(it.startedAt)
      : parentRow?.start ? new Date(parentRow.start)
      : todayD; // ìµœí›„ ë°©ì–´

    // í¬í•¨-í¬í•¨ ì˜ì—…ì¼ ì¹´ìš´íŠ¸ (ê°™ì€ ë‚  ì‹œì‘/ì™„ë£Œë©´ 1ì¼)
    let actualUsed = bizDaysBetween(startAnchor, todayD);

    // í•„ìš”í•˜ë©´ â€œê°™ì€ ë‚ ì€ 0ì¼ë¡œ ì·¨ê¸‰â€ ì›í•œë‹¤ë©´ ì•„ë˜ í•œ ì¤„ ì£¼ì„ í•´ì œ
    // actualUsed = Math.max(0, actualUsed - 1);

    state.reports.push({
      id: uid(),
      owner: it.owner,
      name: it.name,
      pd: it.pd || '',
      usedDays: Math.max(0, actualUsed),
      month: (todayD.getMonth() + 1),
      completedAt: todayISO
    });
  } else {
    // 3) ìì‹/ë™ì‹œì‘ì—…(ê°„ë‹¨ìˆ˜ì • ì œì™¸)ì€ â€œë°°ì •ì¼â€ë§Œ ê¸°ë¡ (ì˜¤ë²„ëŠ” ë¶€ëª¨ì—ë§Œ ë°˜ì˜)
    const childRow   = plannedNow.find(p => p.id === it.id);
    const childTotal = childRow?.meta?.total ?? ((it.duration || 0) + (it.extraDays || 0));
    state.reports.push({
      id: uid(),
      owner: it.owner,
      name: it.name,
      pd: it.pd || '',
      usedDays: Math.max(0, childTotal),
      month: (todayD.getMonth() + 1),
      completedAt: todayISO
    });
  }
});



  // ì™„ë£Œëœ ë¬¶ìŒ ì œê±°
  if (ids.has(__lastTopId)) __lastTopId = null;
  state.tasks = state.tasks.filter(x=> !ids.has(x.id));

  // ë‹¤ìŒ ê¸°ì¤€ì¼ = ì™„ë£Œ 'ë‹¤ìŒ' ì˜ì—…ì¼ (ì™„ë£Œ ë‹¹ì¼ì€ ë¹„ì›€)
  const nextStart = toISO(addBizDays(todayD, 1));
  state.startByOwner[state.owner] = nextStart;

  // ì €ì¥/ë Œë”
  localStorage.setItem('sched:startByOwner', JSON.stringify(state.startByOwner));
  localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
  localStorage.setItem('sched:reports', JSON.stringify(state.reports));
  state.reportTabKey = String(todayD.getMonth()+1);

  renderAll();
  saveNowAuto();
}




/* =========================
 * Telegram (ì›ë³¸ ìœ ì§€)
 * ========================= */
const TELEGRAM_BOT_TOKEN = "8479716195:AAGzTK4YRcUojESzOvI-79YZurBjgkdjItk";
const TELEGRAM_CHAT_ID   = "421516816";
const PD_CHAT_MAP = { "ê¹€ì •ìš©": "421516816" };

function parsePDs(pdStr){
  return (pdStr||"").replace(/PD[:ï¼š]?\s*/gi, "")
    .split(/[,\/*|Â·]+|\s{2,}/g).map(s=>s.trim()).filter(Boolean);
}
async function sendTelegramMessage(text, chatId){
  if(!TELEGRAM_BOT_TOKEN || !chatId) return;
  try{
    await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
      method: "POST", headers: { "Content-Type":"application/json" },
      body: JSON.stringify({ chat_id: chatId, text })
    });
  }catch(_e){}
}
function sendToPDs(pdStr, text){
  const uniq = new Set();
  parsePDs(pdStr).forEach(name=>{
    const id = getPDChatIdFromStorage(name) || PD_CHAT_MAP[name];
    if(id) uniq.add(id);
  });
  uniq.forEach(id=> sendTelegramMessage(text, id));
}
const PD_CHAT_STORAGE_KEY = 'sched:pdchats';
function getPDChatMap(){ try{ return JSON.parse(localStorage.getItem(PD_CHAT_STORAGE_KEY)||'{}'); }catch{ return {}; } }
function getPDChatIdFromStorage(name){ const map = getPDChatMap(); return map[name] || ''; }
function setPDChatIdToStorage(name, id){ const map = getPDChatMap(); map[name] = id; localStorage.setItem(PD_CHAT_STORAGE_KEY, JSON.stringify(map)); }

const QUIET_WINDOW = { startMin: 9*60, endMin: 18*60 };
function isBusinessHour(now = new Date()){
  if (!isBiz(now)) return false;
  const minutes = now.getHours()*60 + now.getMinutes();
  return minutes >= QUIET_WINDOW.startMin && minutes < QUIET_WINDOW.endMin;
}
async function sendTelegramMessageAuto(text, chatId){
  if (!isBusinessHour()){
    console.log('[TG] Quiet hours/holiday/weekend: ìë™ ì•Œë¦¼ ìƒëµ', text);
    return;
  }
  return sendTelegramMessage(text, chatId);
}
function sendToPDsAuto(pdStr, text){
  if (!isBusinessHour()){
    console.log('[TG] Quiet hours/holiday/weekend: ìë™ ì•Œë¦¼ ìƒëµ', text);
    return;
  }
  sendToPDs(pdStr, text);
}
function oneLineLeadMsg(leadName, dateISO){ return `ğŸ“£ ìŠ¤ì¼€ì¤„ ë³€ê²½ | '${leadName}' ì„ í–‰. ì˜ˆì •ì¼ ${dateISO}. í¸ì„±ì— ì§€ì¥ì´ ìˆì„ì‹œ ì œì‘2êµ­ ì¡°ì •í˜„êµ­ì¥ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`; }
function oneLineDelayMsg(leadName, delayedName, newDateISO){ return `ğŸ“£ ìŠ¤ì¼€ì¤„ ë³€ê²½ | '${leadName}' ì„ í–‰ìœ¼ë¡œ '${delayedName}' ì§€ì—°. ì˜ˆì •ì¼ ${newDateISO}. í¸ì„±ì— ì§€ì¥ì´ ìˆì„ì‹œ ì œì‘2êµ­ ì¡°ì •í˜„êµ­ì¥ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`; }
function oneLineSwapDelayedMsg(advName){ return `ğŸ“£ ìˆœì„œ ë³€ê²½ | '${advName}' ì‘ì—…ì´ ë¨¼ì € ì§„í–‰ë©ë‹ˆë‹¤. í¸ì„±ì— ì˜í–¥ì´ ìˆì„ì‹œ ì œì‘2êµ­ ì¡°ì •í˜„êµ­ì¥ì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`; }
function oneLineSwapAdvanceMsg(delayedName){ return `ğŸ“£ ìˆœì„œ ë³€ê²½ | ì¡°ì •í˜„êµ­ì¥ì˜ ìš”ì²­ì— ì˜í•´ '${delayedName}'ë³´ë‹¤ ë¨¼ì € ì§„í–‰ë©ë‹ˆë‹¤.`; }
const TELEGRAM_SVG = `
  <svg class="tg-ic" viewBox="0 0 24 24" aria-hidden="true">
    <path fill="currentColor" d="M22 3L2.6 10.1c-.9.35-.88 1.63.03 1.95l5.33 1.9 1.98 6.04c.26.79 1.25.98 1.8.36l3.25-3.6 5.23 3.69c.73.51 1.75.12 1.95-.78L23.98 4.1C24.2 3.1 23.1 2.5 22 3Zm-7.78 12.46-2.65 2.93-.96-2.94 8.41-8.07-10.8 6.4-3.06-1.1L21 5.6l-6.78 9.86Z"/>
  </svg>
`;
</script>

<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --line:#e5e7eb; --text:#111827; --muted:#6b7280;
    --accent:#1f2937; --pill:#eef2ff; --weekend:#fef3c7; --holiday:#fee2e2;
    --good:#10b981; --good-text:#065f46; --bad:#dc2626; --tg:#229ED9;
  }
  html, body { max-width:100%; overflow-x:hidden; }
  body{font-family:system-ui,Segoe UI,Apple SD Gothic Neo,Apple Color Emoji,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:24px;}
  .wrap{max-width:1100px;margin:0 auto;display:grid;gap:16px;}
  .row{display:grid;gap:10px;}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 2px 8px rgba(0,0,0,.03)}
  header{display:flex;justify-content:space-between;align-items:flex-end;gap:12px;flex-wrap:wrap;}
  h1{font-size:20px;margin:0}
  .muted{color:var(--muted);font-size:12px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .input, .btn, select.input{border:1px solid var(--line);border-radius:10px;padding:10px 12px;background:#fff}
  .btn{cursor:pointer}
  .btn[disabled]{cursor:not-allowed; opacity:.9}
  .btn.primary{ background:#1f2937; color:#fff; border-color:#1f2937; }
  .btn.hold{ border-color:#9ca3af; color:#374151; background:#fff; }
  .btn.danger{ border-color:#ef4444; color:#991b1b; background:#fee2e2; }
  .btn.go{ border-color: var(--good); color: var(--good-text); background:#ecfdf5; }

  .btn.msg-btn{
    background: var(--tg);
    color:#fff;
    border-color: var(--tg);
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 8px 8px;
    line-height: 1;
    border-radius: 8px;
  }
  .btn.msg-btn .tg-ic{ width:16px; height:16px; display:inline-block; flex:0 0 auto; }

  .grid-head, .row-item{ display:grid; grid-template-columns:5fr 1.8fr 1.6fr 1.8fr; align-items:center; }
  .grid-head{background:#f3f4f6; font-size:13px; font-weight:600; border-bottom:1px solid var(--line);}
  .cell{padding:10px;}
  .row-item{ border-bottom:1px solid var(--line); }
  .row-item:hover{background:#fafafa}
  .row-item.dragover{outline:2px dashed #9ca3af;background:#f9fafb}
  .drag{color:#9ca3af;user-select:none;cursor:grab}

  .row-item.inprogress, .row-item.completed{position:relative;}
  .row-item.completed::after{ content:""; position:absolute; left:0; right:0; top:50%; height:1px; background:var(--good); transform:translateY(-.5px); pointer-events:none; }
.row-item.completed{
  background:#f3f4f6;      /* íšŒìƒ‰ ë°°ê²½ */
  color:#6b7280;           /* í…ìŠ¤íŠ¸ íšŒìƒ‰ */
  opacity:1;               /* ë¶ˆíˆ¬ëª… */
  filter:grayscale(1);     /* ì „ì²´ íšŒìƒ‰í†¤ */
  position:relative;
}
.row-item.completed::after{
  content:""; position:absolute; left:0; right:0; top:50%; height:1px;
  background:#9ca3af; transform:translateY(-.5px); pointer-events:none; /* ì¤‘ê°„ ë¼ì¸ë„ íšŒìƒ‰ */
}

.row-item.completed .input,
.row-item.completed .workTypeSel,
.row-item.completed .btn,
.row-item.completed .iconbtn,
.row-item.completed select,
.row-item.completed input{
  pointer-events:none !important;  /* ì™„ì „ ë¹„í™œì„±í™” */
  opacity:.55;                     /* íë¦¬ê²Œ */
}

.row-item.completed .drag{visibility:hidden}

/* ë‹¬ë ¥ ë¼ë²¨/ì ë„ ì™„ë£Œë©´ íë¦¬ê²Œ í‘œì‹œí•  ì¤€ë¹„ */
.taskdot.done .dot{ opacity:.4; filter:grayscale(1); }
.taskdot.done span{ opacity:.6; filter:grayscale(1); }
.dot.done{ opacity:.4; filter:grayscale(1); }


  .status-pill{ display:inline-block; margin-left:6px; padding:2px 6px; border-radius:999px; font-size:11px; line-height:1; border:1px solid var(--line); }
  .status-pill.pending{ background:#fee2e2; color:#991b1b; border-color:#fecaca; }
  .status-pill.inprogress{ background:#d1fae5; color:#065f46; border-color:#a7f3d0; }
  .status-pill.completed{ background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
  .status-pill.concurrent{ background:#dbeafe; color:#1e40af; border-color:#bfdbfe; }

  .badge-plan{ margin-left:6px; padding:2px 6px; border-radius:999px; font-size:11px; line-height:1; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
  .badge-concurrent{ margin-left:6px; padding:2px 6px; border-radius:999px; font-size:11px; line-height:1; background:#dbeafe; color:#1e40af; border:1px solid #bfdbfe; }

  .pd{width:130px}
  .durView{display:flex; align-items:center; gap:8px;}
  .durText{font-variant-numeric: tabular-nums;}
  .over{color:var(--bad); font-weight:600;}
  .iconbtn{ display:inline-flex; align-items:center; justify-content:center; width:22px; height:22px; border:1px solid var(--line); border-radius:6px; background:#fff; font-size:12px; line-height:1; cursor:pointer; }
  .iconbtn[disabled]{ opacity:.5; cursor:not-allowed; }

  .xbtn{
    width:18px; height:18px; padding:0; margin:0;
    border:1px solid var(--line); background:#fff; border-radius:4px;
    font-size:12px; line-height:16px; text-align:center; cursor:pointer;
  }

  .reports{padding:12px 16px 0 16px;}
  .tabbar{display:flex; gap:8px; flex-wrap:wrap; margin-bottom:10px;}
  .tabbtn{ padding:6px 10px; border:1px solid var(--line); border-radius:999px; background:#fff; cursor:pointer; font-size:12px; }
  .tabbtn.active{ background:#111827; color:#fff; border-color:#111827; }
  .report-table{ width:100%; border-collapse:collapse; font-size:13px; }
  .report-table th, .report-table td{ border-bottom:1px solid var(--line); padding:8px 6px; text-align:left; }
  .report-empty{ color:#6b7280; font-size:12px; padding:8px 2px; }

  /* ë‹¬ë ¥ */
  .calendar{padding:16px}
  .month{margin-top:10px}
  .month h3{margin:8px 0 6px;font-size:16px}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
  .dow{font-size:12px;color:#6b7280;text-align:center;padding:6px 0}
  .day{
    min-height:74px;background:#fff;border:1px solid var(--line);border-radius:8px;
    padding:6px;display:grid;grid-template-rows:auto 1fr auto;row-gap:4px;
  }
  .day.weekend{background:#fef3c7}
  .day.holiday{background:#fee2e2}
  .day .date{font-size:12px;color:#374151; align-self:start; position: relative; padding-right:14px; }
  .taskdot{display:flex;align-items:center;gap:6px;font-size:12px; align-self:start;}
  .dot{width:8px;height:8px;border-radius:50%;background:#111827;flex:none}
  .bar{height:3px;border-radius:3px;background:#111827;opacity:.15; align-self:end;}
  .legend{display:flex;gap:12px;font-size:12px;color:#6b7280;padding:0 16px 12px}

  /* ì˜¤ëŠ˜ ë¹¨ê°„ ì  + ì‚´ì§ í„ìŠ¤ */
  .day.today .date::after{
    content:""; position:absolute; right:0; top:50%; transform:translateY(-50%);
    width:8px; height:8px; border-radius:50%; background:#ef4444;
    box-shadow:0 0 0 2px #fff; animation: todayPulse 1.6s ease-in-out infinite;
  }
  @keyframes todayPulse{ 0%{ transform:translateY(-50%) scale(1); opacity:1;}
    70%{ transform:translateY(-50%) scale(1.25); opacity:.55;}
    100%{ transform:translateY(-50%) scale(1); opacity:1;} }

  .month.today-month > h3::after{
    content:" Â· ì˜¤ëŠ˜ í¬í•¨"; margin-left:6px; font-size:12px; color:#ef4444; font-weight:700;
  }

  /* ëª¨ë‹¬ */
  .modal-overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:center; z-index:9999; }
  .modal{ width:min(92vw, 380px); background:#fff; border:1px solid var(--line);
    border-radius:12px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.15); }
  .modal h3{ margin:0 0 10px; font-size:16px; }
  .modal-body{ display:grid; gap:10px; }
  .modal-body label{ font-size:13px; color:#374151; display:grid; gap:6px; }
  .modal-body input{ border:1px solid var(--line); border-radius:8px; padding:8px 10px; }
  .modal-actions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }

  /* ë¹„ë²ˆ/ì €ì¥ ë²„íŠ¼ì€ ëª¨ë°”ì¼ì—ì„œ ìˆ¨ê¹€ */
  @media (max-width: 1100px){ .passbox, #saveBtn { display:none !important; } }
  .passbox{ width:100%; margin-top:8px; padding:8px; border:1px dashed var(--line); border-radius:10px; background:#fafafa; display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .badge-lock{ display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
  .badge-unlock{ display:inline-block; font-size:11px; padding:2px 6px; border-radius:999px; background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
  select.input option.separator { color:#9ca3af; }

  /* ëª¨ë°”ì¼ ë ˆì´ì•„ì›ƒ ìµœì í™” */
  @media (max-width: 1100px) {
    body{ padding:12px; }
    header{ flex-direction:column; align-items:flex-start; gap:8px; }
    h1 { font-size: 18px; }
    .controls { gap:6px; }
    header .controls label.muted:nth-of-type(2), header .controls #startDate { display:none !important; }
    .reports{ display:none !important; }
    .calendar{ padding: 8px; }
    .calendar .legend{ display:none !important; }
    .month h3{ font-size:14px; margin:6px 0; }
    .dow{ font-size:11px; padding:4px 0; }
    .day{ min-height:48px; padding:6px; grid-template-rows: auto 1fr; }
    .taskdot, .bar{ display:none !important; }
    .m-count{ justify-self:start; margin-top:2px; display:inline-grid; place-items:center;
      width:22px; height:22px; border-radius:999px; border:1px solid var(--line);
      font-size:12px; background:#fff; color:#111827; }
    .grid-head, .row-item{ grid-template-columns: 2fr 1fr 1fr; gap: 4px; }
    .row-item .cell{ padding:6px 4px; min-width:0; }
    .row-item .cell:first-child{ display:flex; align-items:center; gap:6px; min-width:0; }
    .drag { display:none; }
    .m-line{ font-size:13px; line-height:1.35; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .namePrefix{ color:#9ca3af; margin-right:6px; }
    .btn{ padding:4px 6px; font-size:11px; border-radius:8px; }
    .iconbtn{ width:18px; height:18px; font-size:11px; border-radius:5px; }
    .pd{ width:auto; min-width:120px; }
    .pill{ font-size:11px; padding:4px 6px; white-space:nowrap; }
    .m-date{ font-size:12px; text-align:center; margin:0 auto; display:block; color:#374151; }
    .status-pill{ padding:2px 6px; font-size:11px; }
    .grid-head{ display:none !important; }
    .add-task-form { display:none !important; }
  }

  /* ìƒ‰ìƒ ê°•ì¡°/ì§€ì—°ì¼ */
  .day.colored .date{ font-weight:700; }
  .day .bar{ display:none !important; }
  .day .taskdot .dot{ width:8px; height:8px; opacity:1; }
  .day.delay{ box-shadow: inset 0 0 0 2px var(--bad); border-color: var(--bad) !important; }
  
  /* ë°ìŠ¤í¬í†±(1100px ì´ìƒ)ì—ì„œ NEW/ìˆ˜ì •/ê°„ë‹¨ìˆ˜ì • select ë°•ìŠ¤ë¥¼ ë” ì‘ê²Œ */
@media (min-width: 1100px) {
  select.input.workTypeSel {
    width: 80px !important;   /* ê¸°ë³¸ 90px â†’ ë” ì‘ê²Œ */
    padding: 1px 4px;         /* ì•ˆìª½ ì—¬ë°± ì¤„ì„ */
    height: 25px;             /* ë†’ì´ ì¤„ì„ */
    font-size: 12px;          /* ê¸€ì í¬ê¸° ì¤„ì„ */
    line-height: 1.2;
    border-radius: 4px;       /* ë‘¥ê·¼ ì •ë„ ì¤„ì„ */
  }
}

/* ì•¡ì…˜ ë²„íŠ¼ ê°„ê²©/ì •ë ¬ */
.cell.actions{
  display: flex;
  align-items: center;
  gap: 8px;          /* â† ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
  flex-wrap: wrap;   /* ì¹¸ì´ ì¢ì„ ë•Œ ì¤„ë°”ê¿ˆ í—ˆìš© */
}

/* ë°ìŠ¤í¬í†±ì—ì„œ ì¡°ê¸ˆ ë” ì—¬ìœ  */
@media (min-width: 1100px){
  .cell.actions{ gap: 10px; }
}

/* í…”ë ˆê·¸ë¨ ë²„íŠ¼ë§Œ ì‚´ì§ ê°„ê²© ë³´ì •ì´ í•„ìš”í•˜ë©´(ì„ íƒ) */
.cell.actions .btn.msg-btn{ padding-left: 10px; padding-right: 10px; }





</style>
</head>
<body>
<div class="wrap">
  <div class="row card" style="padding:16px">
    <header>
      <div>
        <h1>CGì‘ì—… ìŠ¤ì¼€ì¤„í‘œ</h1>
        <div class="muted" id="statusLine"></div>
      </div>
      <div class="controls">
        <label class="muted">ë‹´ë‹¹ì</label>
        <select id="ownerSel" class="input"></select>

        <label class="muted">ì˜¤ëŠ˜</label>
        <input id="startDate" type="date" class="input" disabled />
        <button id="saveBtn" class="btn primary" style="margin-left:8px">ì €ì¥</button>
      </div>

      <div class="passbox">
        <span id="lockBadge" class="badge-lock">ì ê¸ˆ</span>
        <input id="editPass" type="password" class="input" style="width:160px" placeholder="í¸ì§‘ ë¹„ë°€ë²ˆí˜¸" />
        <button id="passBtn" class="btn">ì ê¸ˆ í•´ì œ</button>
        <button id="passOffBtn" class="btn" style="display:none;">ë‹¤ì‹œ ì ê¸ˆ</button>
      </div>
    </header>

    <!-- === TEST PANEL (ë¶™ì˜€ë‹¤ ë–¼ê¸° ì‰¬ì›€) === -->
    <div id="testPanel" class="test-panel" style="display:block">
      <strong style="font-size:12px;">í…ŒìŠ¤íŠ¸</strong>
      <button class="tbtn" data-jump="-5">ì˜¤ëŠ˜-5</button>
      <button class="tbtn" data-jump="-1">ì˜¤ëŠ˜-1</button>
      <button class="tbtn primary" id="tp-today">ì‹¤ì œì˜¤ëŠ˜</button>
      <button class="tbtn" data-jump="+1">ì˜¤ëŠ˜+1</button>
      <button class="tbtn" data-jump="+5">ì˜¤ëŠ˜+5</button>
      <span class="sep">|</span>
      <input type="date" id="tp-date">
      <button class="tbtn" id="tp-apply">ì ìš©</button>
      <button class="tbtn" id="tp-clear">ëª¨ì˜í•´ì œ</button>
      <span class="sep">|</span>
      <button class="tbtn" id="tp-sample">ìƒ˜í”Œì‘ì—… ì¶”ê°€</button>
      <button class="tbtn danger" id="tp-wipe">í˜„ì¬ ì‚¬ìš©ì ì‘ì—… ì‚­ì œ</button>
    </div>

    <script>
    /* === TEST PANEL JS === */
    (function(){
      const pad = n => String(n).padStart(2,'0');
      const toISO = (d)=>{ const x=new Date(d); x.setHours(0,0,0,0); return `${x.getFullYear()}-${pad(x.getMonth()+1)}-${pad(x.getDate())}`; };
      const parseISO = (s)=>{ const [y,m,d]=s.split('-').map(Number); const x=new Date(y, m-1, d); x.setHours(0,0,0,0); return x; };
      const addDaysISO = (iso, delta)=> toISO(new Date(parseISO(iso).getTime() + delta*86400000));
      const $ = (sel)=>document.querySelector(sel);
      const root = $('#testPanel');
      if(!root) return;

      // í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„ì¹˜ ON
      window.__TEST_MODE__ = true;

      function currentBaseISO(){ return getTodayISO(); }

      function applyMock(iso){
        window.__FORCE_TODAY__ = iso;   // âœ… ì˜¤ì§ í™”ë©´/ì—”ì§„ì˜ "ì˜¤ëŠ˜"ë§Œ ë³€ê²½
        // âŒ baseline(startByOwner)ì€ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
        renderAll();
      }
      function clearMock(){
        delete window.__FORCE_TODAY__;
        renderAll();
      }

      root.querySelectorAll('.tbtn[data-jump]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const dj = parseInt(btn.getAttribute('data-jump'),10);
          const next = addDaysISO(currentBaseISO(), dj);
          applyMock(next);
          const inp = $('#tp-date'); if(inp) inp.value = next;
        }, {passive:true});
      });

      $('#tp-today')?.addEventListener('click', ()=>{
        const real = getRealTodayISO();
        applyMock(real);
        const inp = $('#tp-date'); if(inp) inp.value = real;
      }, {passive:true});

      $('#tp-apply')?.addEventListener('click', ()=>{
        const v = ($('#tp-date')?.value||'').trim();
        if(!/^\d{4}-\d{2}-\d{2}$/.test(v)) { alert('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš” (YYYY-MM-DD)'); return; }
        applyMock(v);
      }, {passive:true});

      $('#tp-clear')?.addEventListener('click', ()=>{
        clearMock();
        const inp = $('#tp-date'); if(inp) inp.value = '';
      }, {passive:true});

      $('#tp-sample')?.addEventListener('click', ()=>{
        if(!state || !state.owner) return alert('ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.');
        const base = getTodayISO();
        const t = {
          id: 'sample-'+Math.random().toString(36).slice(2,9),
          owner: state.owner,
          name: 'ìƒ˜í”Œì‘ì—… '+base,
          duration: 2,
          extraDays: 0,
          pd: 'ê¹€ì •ìš©',
          workType: 'NEW',
          parallel: false,
          group: null,
          planned: true,
          inProgress: false,
          completed: false,
          startedAt: null,
          completedAt: null,
          spentDays: 0,
          activeSinceISO: null
        };
        state.tasks.push(t);
        localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
        renderAll(); saveNowAuto();
      }, {passive:true});

      $('#tp-wipe')?.addEventListener('click', ()=>{
        if(!state || !state.owner) return;
        if(!confirm(`"${state.owner}"ì˜ ì‘ì—…ì„ ëª¨ë‘ ì‚­ì œí• ê¹Œìš”?`)) return;
        state.tasks = state.tasks.filter(x=> x.owner !== state.owner);
        localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
        renderAll(); saveNowAuto();
      }, {passive:true});

      const ini = currentBaseISO();
      const inp = $('#tp-date'); if(inp) inp.value = ini;
    })();
    </script>

    <!-- ë°ìŠ¤í¬í†± ì‘ì—… ì¶”ê°€ í¼ -->
    <div class="controls add-task-form">
      <input id="taskName" class="input" placeholder="ì‘ì—… ì´ë¦„" />
      <input id="taskPD" class="input pd" placeholder="ë‹´ë‹¹ PD" />
      <input id="taskDur" class="input" type="number" min="1" value="1" style="width:120px" />
      <select id="taskType" class="input" style="width:100px">
        <option value="NEW">NEW</option>
        <option value="ìˆ˜ì •">ìˆ˜ì •</option>
        <option value="ê°„ë‹¨ìˆ˜ì •">ê°„ë‹¨ìˆ˜ì •</option>
        <option value="ì „ì²´ìˆ˜ì •">ì „ì²´ìˆ˜ì •</option>
      </select>
      <label class="chk"><input id="taskPlanned" type="checkbox" class="toggle" />ì˜ˆì •</label>
      <button id="addBtn" class="btn primary">ì¶”ê°€</button>
    </div>
  </div>

  <!-- ë¦¬í¬íŠ¸/ë³´ë¥˜ -->
  <div id="reportsCard" class="row card reports">
    <div id="reportTabs" class="tabbar"></div>
    <div id="reportPanel"></div>
  </div>

  <div class="row card">
    <div class="grid-head">
      <div class="cell header-task">ì‘ì—…ë‚´ìš© / ë‹´ë‹¹ PD</div>
      <div class="cell header-dur">ê¸°ê°„(ì¼)</div>
      <div class="cell header-start">ì˜ˆì •ì‹œì‘</div>
      <div class="cell header-act">ì§„í–‰ìƒíƒœ</div>
    </div>
    <div id="taskRows"></div>
  </div>

  <div class="row card calendar">
    <div class="legend">
      <span><span class="sw weekend" style="display:inline-block;width:12px;height:12px;border:1px solid var(--line);border-radius:3px;background:#fef3c7;vertical-align:-2px;margin-right:6px"></span>ì£¼ë§</span>
      <span><span class="sw holiday" style="display:inline-block;width:12px;height:12px;border:1px solid var(--line);border-radius:3px;background:#fee2e2;vertical-align:-2px;margin-right:6px"></span>ê³µíœ´ì¼</span>
    </div>
    <div id="calendarMount"></div>
  </div>
</div>

<div id="modalHost"></div>

<script>
/* =========================
 * ë“œë¡­ë‹¤ìš´(ì‚¬ìš©ì ì¶”ê°€/ì‚­ì œ)
 * ========================= */
function renderOwnerDropdown(){
  const sel = $('#ownerSel');
  sel.innerHTML = '';

  state.owners.forEach(name=>{
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });

  if (!isMobileView()){
    const sep = document.createElement('option');
    sep.disabled = true; sep.className = 'separator'; sep.textContent = 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€';
    sel.appendChild(sep);

    const add = document.createElement('option'); add.value = '__add__'; add.textContent = 'â• ì‚¬ìš©ì ì¶”ê°€â€¦'; sel.appendChild(add);
    const del = document.createElement('option'); del.value = '__delete__'; del.textContent = 'ğŸ—‘ï¸ ì‚¬ìš©ì ì‚­ì œâ€¦'; sel.appendChild(del);
  }

  if (state.owners.includes(state.owner)) sel.value = state.owner;
  else { state.owner = state.owners[0] || ''; sel.value = state.owner; }
}

/* =========================
 * ë‹¬ë ¥ í—¬í¼
 * ========================= */
function buildDateMap(rows){
  const map=new Map();
  for(const r of rows){
    if(!r.start) continue;
    let d=new Date(r.start);
    while(d<=r.end){
      if(isBiz(d)){
        const key=toISO(d);
        if(!map.has(key)) map.set(key,{list:[],firstId:null});
        const obj=map.get(key);
        obj.list.push({id:r.id,name:r.name,pd:r.pd||'', completed: !!r.completed});

        if(!obj.firstId) obj.firstId=r.id;
      }
      d.setDate(d.getDate()+1);
    }
  }
  return map;
}

/* =========================
 * ë‹¬ë ¥ ë Œë”
 * ========================= */
function renderCalendar(planned, owner, activeTopId){
  const mount = $('#calendarMount');
  mount.innerHTML = '';

  const filtered = planned.filter(p => p.start);

  // âœ… ì‘ì—…ì´ ì—†ì–´ë„ ë‹¬ë ¥ì€ í•­ìƒ ë Œë”: í˜„ì¬ ë‹¬ì„ ê¸°ë³¸ ë²”ìœ„ë¡œ ì‚¬ìš©
  const todayISO = getTodayISO();
  const todayD   = parseISO(todayISO);
  const defaultStart = new Date(todayD.getFullYear(), todayD.getMonth(), 1);
  const defaultEnd   = new Date(todayD.getFullYear(), todayD.getMonth()+1, 0);
  const noTasks = filtered.length === 0;

  // (ì„ íƒ) ì•ˆë‚´ ë¬¸êµ¬ë§Œ ë³´ì—¬ì£¼ê³ , ë‹¬ë ¥ ìì²´ëŠ” ê³„ì† ê·¸ë¦¼
  if (noTasks){
    const info = document.createElement('div');
    info.className = 'muted';
    info.style.margin = '0 0 6px 2px';
    info.textContent = 'ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤. (ë‹¬ë ¥ì€ í˜„ì¬ ë‹¬ë¡œ í‘œì‹œë©ë‹ˆë‹¤)';
    mount.appendChild(info);
  }

  // ì§€ì—°ì¼(ë¹¨ê°„ í…Œë‘ë¦¬) ê³„ì‚°ì€ ê¸°ì¡´ ê·¸ëŒ€ë¡œ
  const delaySet = new Set();
  if (activeTopId){
    const top = planned.find(p => p.id === activeTopId);
    if (top && top.meta && top.meta.overdueDays > 0){
      const today = parseISO(getTodayISO());
      const expEnd = top.meta.expectedEnd instanceof Date
        ? top.meta.expectedEnd
        : parseISO(toISO(top.meta.expectedEnd));
      let cur = addBizDays(expEnd, 1);
      while(cur <= today){
        if(isBiz(cur)) delaySet.add(toISO(cur));
        cur.setDate(cur.getDate()+1);
      }
    }
  }

  // ë²”ìœ„ ì›” êµ¬ì„±: ì‘ì—… ì—†ìœ¼ë©´ í˜„ì¬ ë‹¬ ì‚¬ìš©
  let months = [];
  const minStart = noTasks
    ? defaultStart
    : filtered.reduce((d, r) => (r.start < d ? r.start : d), filtered[0].start);
  const maxEnd = noTasks
    ? defaultEnd
    : filtered.reduce((d, r) => (r.end > d ? r.end : d), filtered[0].end);

  const minDate = new Date(minStart);
  const maxDate = new Date(maxEnd);
  const iter = new Date(minDate.getFullYear(), minDate.getMonth(), 1);
  const last = new Date(maxDate.getFullYear(), maxDate.getMonth(), 1);
  while (iter <= last){ months.push(new Date(iter)); iter.setMonth(iter.getMonth() + 1); }

  const dateMap = buildDateMap(filtered);
  const MONTH_NAMES = ['1ì›”','2ì›”','3ì›”','4ì›”','5ì›”','6ì›”','7ì›”','8ì›”','9ì›”','10ì›”','11ì›”','12ì›”'];
  const DOW = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

  months.forEach(m0 => {
    const y = m0.getFullYear(), m = m0.getMonth();

    const box = document.createElement('div');
    box.className = 'month';
    // CSSì— .month.today-month > h3::after ìŠ¤íƒ€ì¼ì´ ìˆìœ¼ë¯€ë¡œ í‘œì‹œë¥¼ ìœ„í•´ í´ë˜ìŠ¤ ë¶€ì—¬
    if (y === todayD.getFullYear() && m === todayD.getMonth()){
      box.classList.add('today-month');
    }
    box.innerHTML = `<h3>${y}ë…„ ${MONTH_NAMES[m]} â€” ${owner}</h3>`;

    const head = document.createElement('div');
    head.className = 'cal-grid';
    DOW.forEach(d => {
      const el = document.createElement('div');
      el.className = 'dow';
      el.textContent = d;
      head.appendChild(el);
    });
    box.appendChild(head);

    const grid = document.createElement('div'); grid.className = 'cal-grid';
    const firstDay = new Date(y, m, 1);
    for (let i = 0; i < firstDay.getDay(); i++){ grid.appendChild(document.createElement('div')); }

    const daysInMonth = new Date(y, m + 1, 0).getDate();
    for (let d = 1; d <= daysInMonth; d++){
      const cur = new Date(y, m, d); cur.setHours(0,0,0,0);
      const iso = toISO(cur);

      const cell = document.createElement('div');
      cell.className = 'day' + (isWeekend(cur) ? ' weekend' : '') + (isHoliday(cur) ? ' holiday' : '');

      const dateEl = document.createElement('div');
      dateEl.className = 'date';
      dateEl.textContent = d + (isHoliday(cur) ? ' ğŸŒ' : '');
      cell.appendChild(dateEl);

      if (toISO(cur) === todayISO){ cell.classList.add('today'); }

      if (delaySet.has(iso) && !cell.classList.contains('weekend') && !cell.classList.contains('holiday')){
        cell.classList.add('delay');
      }

      const info = dateMap.get(iso);
      if (info){
        const isBizDay = !isWeekend(cur) && !isHoliday(cur);
        if (isBizDay){
          const first = info.list[0];
          const color = getProjectColor(first.id);
          const textColor = getContrastText(color);

          cell.classList.add('colored');
          cell.style.background = color;
          cell.style.borderColor = color;
          dateEl.style.color = textColor;

          if (isMobileView()){
            const row = document.createElement('div');
            row.className = 'proj-row';
            info.list.forEach(() => {
              const dot = document.createElement('span');
              dot.className = 'dot';
              dot.style.background = textColor;
              dot.style.display = 'inline-block';
              row.appendChild(dot);
            });
            cell.appendChild(row);
          } else {
            info.list.forEach(item => {
              const line = document.createElement('div');
              line.className = 'taskdot';
              const dot = document.createElement('span'); dot.className = 'dot'; dot.style.background = textColor;
              const label = document.createElement('span'); label.style.color = textColor;
              label.textContent = item.pd ? `${item.name} (${item.pd})` : item.name;
              line.appendChild(dot); line.appendChild(label); cell.appendChild(line);
            });
          }
          cell.title = info.list.map(x => x.pd ? `${x.name} (${x.pd})` : x.name).join('\n');
        }
      }
      grid.appendChild(cell);
    }
    box.appendChild(grid);
    mount.appendChild(box);
  });
}


/* =========================
 * ë¦¬í¬íŠ¸/ë³´ë¥˜ ë Œë”
 * ========================= */
function renderReports(){
  const tabs = $('#reportTabs');
  const panel = $('#reportPanel');
  tabs.innerHTML=''; panel.innerHTML='';

  const nowKey = (new Date().getMonth()+1).toString();
  if(!state.reportTabKey) state.reportTabKey = nowKey;

  for(let m=1;m<=12;m++){
    const key = m.toString();
    const b = document.createElement('button');
    b.className = 'tabbtn'+(key===state.reportTabKey?' active':'' );
    b.textContent = `${m}ì›”`;
    b.addEventListener('click', ()=>{ state.reportTabKey = key; renderReports(); }, {passive:true});
    tabs.appendChild(b);
  }
  const holdBtn = document.createElement('button');
  holdBtn.className = 'tabbtn'+(state.reportTabKey==='hold'?' active':'' );
  holdBtn.textContent = 'ë³´ë¥˜í”„ë¡œì íŠ¸';
  holdBtn.addEventListener('click', ()=>{ state.reportTabKey='hold'; renderReports(); }, {passive:true});
  tabs.appendChild(holdBtn);

  if(state.reportTabKey==='hold'){
    const list = state.holds.filter(h=> h.owner===state.owner);
    if(!list.length){ panel.innerHTML = '<div class="report-empty">ë³´ë¥˜ ì¤‘ì¸ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
    const rows = list.map(h=>`
      <tr data-id="${h.id}">
        <td>${(h.name||'').replace(/</g,'&lt;')}</td>
        <td>${(h.pd||'').replace(/</g,'&lt;')}</td>
        <td style="white-space:nowrap; display:flex; gap:6px; align-items:center;">
          <button class="btn primary hold-resume">ì‘ì—…ì¬ê°œ</button>
          <button class="btn delete hold-delete">ì‚­ì œ</button>
        </td>
      </tr>`).join('');
    panel.innerHTML = `
      <table class="report-table">
        <thead><tr><th>ì‘ì—…ë‚´ìš©</th><th>ë‹´ë‹¹ PD</th><th>ì•¡ì…˜</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>`;
    panel.querySelectorAll('.hold-resume').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(!canEdit()) return;
        const tr = btn.closest('tr');
        const id = tr.getAttribute('data-id');
        const idx = state.holds.findIndex(h=>h.id===id && h.owner===state.owner);
        if(idx>=0){
          const task = {...state.holds[idx]};
          task.planned = true; task.inProgress=false; task.completed=false;
          task.startedAt=null; task.completedAt=null; delete task.heldAt;
          state.tasks.push(task); state.holds.splice(idx,1);
          localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
          localStorage.setItem('sched:holds', JSON.stringify(state.holds));
          state.reportTabKey = (new Date().getMonth()+1).toString();
          renderAll(); saveNowAuto();
          alert('ì¬ê°œë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¸ ëª©ë¡ì˜ "ì‘ì—…ì‹œì‘" ë²„íŠ¼ìœ¼ë¡œ ì‹œì‘ì¼ì„ ì„¤ì •í•˜ì„¸ìš”.');
        }
      }, {passive:true});
    });
    panel.querySelectorAll('.hold-delete').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(!canEdit()) return;
        const tr = btn.closest('tr'); const id = tr.getAttribute('data-id');
        const idx = state.holds.findIndex(h=>h.id===id && h.owner===state.owner);
        if(idx>=0){
          if(!confirm('ë³´ë¥˜ í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?')) return;
          state.holds.splice(idx,1);
          localStorage.setItem('sched:holds', JSON.stringify(state.holds));
          renderReports(); saveNowAuto();
        }
      }, {passive:true});
    });
    return;
  }

  const monthNum = parseInt(state.reportTabKey,10);
  const list = state.reports.filter(r=> r.owner===state.owner && r.month===monthNum);
  if(!list.length){
    panel.innerHTML = '<div class="report-empty">ì´ ë‹¬ì˜ ì™„ë£Œ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  const rows = list.map(r=>`
    <tr data-rid="${r.id || ''}">
      <td>${(r.name||'').replace(/</g,'&lt;')}</td>
      <td>${(r.pd||'').replace(/</g,'&lt;')}</td>
      <td>${r.usedDays}ì¼</td>
      <td class="shy"><button class="xbtn report-delete" title="ì‚­ì œ">Ã—</button></td>
    </tr>`).join('');
  panel.innerHTML = `
    <table class="report-table">
      <thead><tr><th>ì‘ì—…ë‚´ìš©</th><th>ë‹´ë‹¹ PD</th><th>ì‘ì—…ì†Œìš”ì‹œê°„</th><th class="shy"></th></tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
  panel.querySelectorAll('.report-delete').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      if(!canEdit()) return;
      const tr = btn.closest('tr');
      const rid = tr.getAttribute('data-rid');
      let removed = false;
      if(rid){
        const idx = state.reports.findIndex(r=> r.id===rid);
        if(idx>=0){ state.reports.splice(idx,1); removed = true; }
      }
      if(!removed){
        const name = tr.children[0].innerText;
        const pd = tr.children[1].innerText;
        const usedDays = parseInt((tr.children[2].innerText||'').replace(/\D/g,''),10);
        const idx = state.reports.findIndex(r=> r.owner===state.owner && r.month===monthNum && (r.name===name) && ((r.pd||'')===pd) && r.usedDays===usedDays);
        if(idx>=0) state.reports.splice(idx,1);
      }
      localStorage.setItem('sched:reports', JSON.stringify(state.reports));
      renderReports(); saveNowAuto();
    }, {passive:true});
  });
}

/* =========================
 * ë©”ì¸ í…Œì´ë¸” ë Œë”
 * ========================= */
function renderTable(){
  renderOwnerDropdown();

  const startBase = state.startByOwner[state.owner] || getRealTodayISO(); // âœ… ê¸°ì¤€ì¼ì€ í•­ìƒ ì‹¤ì œ ì˜¤ëŠ˜ì„ ê¸°ë³¸
  $('#startDate').value = getTodayISO(); // í™”ë©´ì—ëŠ” (TEST ë°˜ì˜í•œ) ì˜¤ëŠ˜ í‘œì‹œ

  const rowsEl = $('#taskRows'); rowsEl.innerHTML='';

  // ê·¸ë£¹ ìœ íš¨ì„±
  const ownerIds = new Set(state.tasks.filter(x => x.owner === state.owner).map(x => x.id));
  state.tasks = state.tasks.map(t => {
    if (t.owner !== state.owner) return t;
    const valid = t.group && ownerIds.has(t.group) && isSimple(t);
    return valid ? t : { ...t, group: null };
  });

  const visibleTasks = state.tasks.filter(t=>t.owner===state.owner);

  // ì§„í–‰ì¤‘ í›„ë³´ (ì²« ë©”ì¸)
  const firstActiveMain = visibleTasks.find(t=>!t.group && !t.completed && !t.planned);
  const progressingId = firstActiveMain ? firstActiveMain.id : null;
  syncTopProgress(progressingId);

  const planned = computeSchedule(visibleTasks, startBase, progressingId);
  
  
  
  // âœ… ì™„ë£Œ í•­ëª©ë„ í¬í•¨: ìµœê·¼ 7ì¼ ë‚´ì˜ ì™„ë£Œë§Œ ì¶”ê°€
const RECENT_DAYS = 7;
const today = getRealTodayDate();
const recentCompleted = (state.reports || [])
  .filter(r => {
    if (r.owner !== state.owner || !r.completedAt) return false;
    const d = parseISO(r.completedAt);
    const diff = Math.floor((today - d) / 86400000);
    return diff >= 0 && diff <= RECENT_DAYS;
  })
  .map(r => {
    const date = parseISO(r.completedAt);
    return {
      id: 'done-' + r.id,
      start: date,
      end: date,
      name: r.name,
      pd: r.pd || '',
      completed: true,
      meta: { total: 1 }
    };
  });

const plannedWithCompleted = [...planned, ...recentCompleted];
renderCalendar(plannedWithCompleted, state.owner, progressingId);


  const mobile = isMobileView();

  planned.forEach((t, idx)=>{
    const isChild = !!t.group;
    const isInProgress = (t.id===progressingId) && !t.planned && !t.completed;

    const total = t.meta ? t.meta.total : ((t.duration||0)+(t.extraDays||0));
    const progress = t.meta ? t.meta.progress : 0;
    const canCompleteNow = !t.completed && !t.planned && !isChild && (progress >= total);

    // ìƒíƒœ ë±ƒì§€
    let statusHTML;
    if (t.completed) statusHTML = '<span class="status-pill completed">ì™„ë£Œ</span>';
    else if (isChild && isSimple(t)) statusHTML = '<span class="status-pill concurrent">ë™ì‹œ</span>';
    else if (isInProgress) statusHTML = '<span class="status-pill inprogress">ì§„í–‰ì¤‘</span>';
    else statusHTML = '<span class="status-pill pending">ì˜ˆì •ì¤‘</span>';

    const row = document.createElement('div');
    const cls = ['row-item']; if (isChild) cls.push('child'); if (isInProgress && !t.completed) cls.push('inprogress'); if (t.completed) cls.push('completed');
    row.className = cls.join(' ');

    const workTypeSelectHTML = `
      <select class="input workTypeSel" style="width:90px">
        <option value="NEW"${t.workType==='NEW'?' selected':''}>NEW</option>
        <option value="ìˆ˜ì •"${t.workType==='ìˆ˜ì •'?' selected':''}>ìˆ˜ì •</option>
        <option value="ê°„ë‹¨ìˆ˜ì •"${t.workType==='ê°„ë‹¨ìˆ˜ì •'?' selected':''}>ê°„ë‹¨ìˆ˜ì •</option>
        <option value="ì „ì²´ìˆ˜ì •"${t.workType==='ì „ì²´ìˆ˜ì •'?' selected':''}>ì „ì²´ìˆ˜ì •</option>
      </select>`;

    const leftHTML = `
      <span class="drag" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â‰¡</span>
      ${isChild?'<span class="namePrefix" style="color:#9ca3af;margin-right:6px">â†³</span>':''}
      <input class="input nameInput" style="margin-left:8px" value="${(t.name||'').replace(/"/g,'&quot;')}" ${canEdit()?'':'disabled'} />
      <input class="input pd pdInput" placeholder="ë‹´ë‹¹ PD" value="${(t.pd||'').replace(/"/g,'&quot;')}" ${canEdit()?'':'disabled'} />
      ${canEdit()? workTypeSelectHTML : workTypeSelectHTML.replace('class="input workTypeSel"','class="input workTypeSel" disabled')}
      ${t.planned ? (isChild && isSimple(t) ? '<span class="badge-concurrent">ë™ì‹œ</span>' : '<span class="badge-plan">ì˜ˆì •</span>') : ''}
    `;

    const incBtnHTML = `<button class="iconbtn incBtn" title="í•˜ë£¨ ì¶”ê°€" ${(canEdit() && !(isSimple(t) && isChild))?'':'disabled'}>â–²</button>`;
    const idBtnHTML = (!isChild)
      ? `<button class="btn msg-btn tg-id-btn" title="PD chat_id ì„¤ì •">${TELEGRAM_SVG}</button>` : "";

    let actionsHTML = '';
    if (t.planned){
      const startBtn = (!isChild && canEdit())
        ? `<button class="btn primary start-task">ì‘ì—…ì‹œì‘</button>`
        : `<button class="btn" disabled>ì‘ì—…ì‹œì‘</button>`;
      actionsHTML = `${startBtn}<button class="btn hold hold-task" ${canEdit()?'':'disabled'}>ë³´ë¥˜</button>${idBtnHTML}`;
    } else {
      let leftBtnHTML;
      if (canCompleteNow) leftBtnHTML = `<button class="btn primary complete-now" ${canEdit()?'':'disabled'}>ì™„ë£Œì²˜ë¦¬</button>`;
      else if (isInProgress) leftBtnHTML = `<button class="btn go mark-complete" ${canEdit()?'':'disabled'}>ì§„í–‰ì¤‘</button>`;
      else if (isChild && isSimple(t)) leftBtnHTML = '<button class="btn concurrent" disabled>ë™ì‹œ</button>';
      else leftBtnHTML = '<button class="btn danger" disabled>ì˜ˆì •ì¤‘</button>';
      actionsHTML = `${leftBtnHTML}<button class="btn hold hold-task" ${canEdit()?'':'disabled'}>ë³´ë¥˜</button>${idBtnHTML}`;
    }

    if(!mobile){
      row.innerHTML = `
        <div class="cell">${leftHTML}</div>
        <div class="cell">
          <div class="durView">
            <span class="durText">${total}ì¼</span>
            ${incBtnHTML}
          </div>
        </div>
        <div class="cell">
          <span class="pill">${t.start ? toISO(t.start) : ''}</span>
          ${statusHTML}
        </div>
        <div class="cell actions">${actionsHTML}</div>`;
    } else {
      const line = [esc(t.name||'Untitled'), esc(t.pd||'-'), esc(t.workType||'NEW')].join(', ');
      let statusCompact = statusHTML.replace('ì§„í–‰ì¤‘','ì§„í–‰').replace('ì˜ˆì •ì¤‘','ì˜ˆì •');
      row.innerHTML = `
        <div class="cell">
          ${isChild?'<span class="namePrefix" aria-hidden="true">â†³</span>':''}
          <span class="m-line" title="${line}">${line}</span>
        </div>
        <div class="cell"><span class="m-date">${t.start ? toISO(t.start) : '-'}</span></div>
        <div class="cell">${statusCompact}</div>`;
    }

    // ë°”ì¸ë”©
    const nameInput = row.querySelector('.nameInput');
    const pdInput   = row.querySelector('.pdInput');
    const workTypeSel = row.querySelector('.workTypeSel');
    const incBtn    = row.querySelector('.incBtn');
    const completeBtn = row.querySelector('.complete-now');
    const holdBtn   = row.querySelector('.hold-task');
    const startBtn  = row.querySelector('.start-task');
    const handle    = row.querySelector('.drag');
    const idBtn     = row.querySelector('.tg-id-btn');
    const markBtn   = row.querySelector('.mark-complete');

    if (idBtn){
      idBtn.addEventListener('click', ()=>{
        const names = parsePDs(t.pd);
        if(!names.length){ alert('PD ì´ë¦„ì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € PDë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
        const existing = getPDChatIdFromStorage(names[0]) || PD_CHAT_MAP[names[0]] || '';
        const val = prompt(`PD: ${names.join(', ')}\nchat_idë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì…ë ¥í•œ ê°’ì„ ìœ„ PD ì „ì›ì—ê²Œ ì €ì¥):`, existing);
        if(!val) return;
        const id = val.trim(); names.forEach(n => setPDChatIdToStorage(n, id));
        alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      }, {passive:true});
    }

    [nameInput, pdInput].forEach(el=>{ if(!el) return; el.setAttribute('draggable','false'); el.addEventListener('dragstart', e=>e.preventDefault(), {passive:true}); });

    if(incBtn && !incBtn.disabled){
      incBtn.addEventListener('click', ()=>{
        if(!canEdit()) return;
        const i = state.tasks.findIndex(x=>x.id===t.id);
        if(i>=0){
          state.tasks[i].extraDays = (state.tasks[i].extraDays||0) + 1;
          localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
          renderAll(); saveNowAuto();
        }
      }, {passive:true});
    }

    if(startBtn){
      startBtn.addEventListener('click', async ()=>{
        if(!canEdit()) return;
        try{
          const def = { startISO: getTodayISO(), duration: (t.duration||1) };
          const { startISO, duration } = await openScheduleDialog(def);
          const i = state.tasks.findIndex(x=>x.id===t.id);
          if(i>=0){
            state.tasks[i].planned = false;
            state.tasks[i].startedAt = startISO;
            state.tasks[i].duration = Math.max(1, parseInt(duration,10)||1);
            localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
            renderAll(); saveNowAuto();
          }
        }catch(e){}
      });
    }

    if(completeBtn){
      completeBtn.addEventListener('click', ()=>{
        if(!canEdit()) return;
        finishTaskBlockAndReschedule(t);
      }, {passive:true});
    }

    if(markBtn){
      markBtn.addEventListener('click', ()=>{
        if(!canEdit()) return;
        if(!confirm('í˜„ì¬ ì‘ì—…ì„ ì™„ë£Œì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        finishTaskBlockAndReschedule(t);
      }, {passive:true});
    }

    if(holdBtn && !holdBtn.disabled){
      holdBtn.addEventListener('click', ()=>{
        if(!canEdit()) { alert('ë¹„ë°€ë²ˆí˜¸ í•´ì œ í›„ ë³´ë¥˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'); return; }
        const cur = state.tasks.find(x=>x.id===t.id);
        if(!cur) return;

        const isParent = !cur.group;
        let ids;
        if(isParent){ ids = collectDescendantIds(state.tasks, cur.id); }
        else{ ids = new Set([cur.id]); }

        const moving = state.tasks.filter(x=> ids.has(x.id));
        const moved = moving.map(x=>({ ...x, planned: true, inProgress:false, completed:false, startedAt:null, completedAt:null, heldAt: getRealTodayISO() }));

        if (ids.has(__lastTopId)) __lastTopId = null;

        state.holds.push(...moved);
        state.tasks = state.tasks.filter(x=> !ids.has(x.id));

        localStorage.setItem('sched:holds', JSON.stringify(state.holds));
        localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
        state.reportTabKey = 'hold';
        renderAll(); saveNowAuto();
      }, {passive:true});
    }

    // ë°ìŠ¤í¬í†± DnD
    if(!mobile && handle){
      handle.setAttribute('draggable','true');
      handle.addEventListener('dragstart', (e)=>{ e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/plain', String(idx)); row.classList.add('dragging'); });
      row.addEventListener('dragend', ()=> row.classList.remove('dragging'));
      row.addEventListener('dragover', (e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; row.classList.add('dragover'); });
      row.addEventListener('dragleave', ()=> row.classList.remove('dragover'));
      row.addEventListener('drop', (e)=>{
        e.preventDefault(); row.classList.remove('dragover');

        const fromPlannedIdx = parseInt(e.dataTransfer.getData('text/plain'),10);
        const toPlannedIdx   = idx;
        if(!Number.isInteger(fromPlannedIdx)) return;

        const visible = state.tasks.filter(x=>x.owner===state.owner);
        const plannedNow = computeSchedule(visible, state.startByOwner[state.owner]||getRealTodayISO(), progressingId);

        const fromTaskId = plannedNow[fromPlannedIdx]?.id;
        const toTaskId   = plannedNow[toPlannedIdx]?.id;
        if(!fromTaskId || !toTaskId) return;

        const fromIdx = state.tasks.findIndex(x=>x.id===fromTaskId);
        const toIdx   = state.tasks.findIndex(x=>x.id===toTaskId);
        if(fromIdx<0 || toIdx<0 || fromIdx===toIdx) return;

        const arr=[...state.tasks];
        const fromTask={...arr[fromIdx]};
        const toTask=arr[toIdx];
        if(fromTask.owner!==state.owner || toTask.owner!==state.owner) return;

        arr.splice(fromIdx,1);
        if(isSimple(fromTask)){
          let insertPos=toIdx+1;
          while(insertPos<arr.length && arr[insertPos].group===toTask.id) insertPos++;
          fromTask.group=toTask.id; 
          arr.splice(insertPos,0,fromTask);
        }else{
          fromTask.group=null;
          const insertPos=toIdx;
          arr.splice(insertPos,0,fromTask);
        }
        state.tasks=arr;

        const visibleAfter = state.tasks.filter(x=>x.owner===state.owner);
        const plannedAfter = computeSchedule(visibleAfter, state.startByOwner[state.owner]||getRealTodayISO(), progressingId);

        // ì•Œë¦¼ ë¡œì§(ì›ë³¸ ìœ ì§€)
        const parentNow   = plannedNow.filter(p => !p.group).map(p => p.id);
        const parentAfter = plannedAfter.filter(p => !p.group).map(p => p.id);

        const oldIdxParent = parentNow.indexOf(fromTaskId);
        const newIdxParent = parentAfter.indexOf(fromTaskId);

        const movingWasMain = !plannedNow[fromPlannedIdx]?.group;
        const isMainAfter   = newIdxParent >= 0;
        const movedUpParent = (newIdxParent >= 0 && oldIdxParent >= 0 && newIdxParent < oldIdxParent);

        if (movingWasMain && isMainAfter && movedUpParent) {
          const adv = plannedAfter.find(p => p.id === fromTaskId);

          if (newIdxParent === 0) {
            const leadStartISO = adv.start ? toISO(adv.start) : getRealTodayISO();
            sendToPDsAuto(adv.pd, oneLineLeadMsg(adv.name, leadStartISO));

            const jumpedParents = parentNow.slice(0, oldIdxParent);
            jumpedParents.forEach(pid=>{
              const delayedAfter = plannedAfter.find(p => p.id === pid);
              if(!delayedAfter) return;
              const newDateISO = delayedAfter.start ? toISO(delayedAfter.start) : getRealTodayISO();
              sendToPDsAuto(delayedAfter.pd, oneLineDelayMsg(adv.name, delayedAfter.name, newDateISO));
            });

          } else {
            const jumpedParents = parentNow.slice(newIdxParent, oldIdxParent);
            jumpedParents.forEach(pid=>{
              const delayedAfter = plannedAfter.find(p => p.id === pid);
              if(!delayedAfter) return;
              sendToPDsAuto(delayedAfter.pd, oneLineSwapDelayedMsg(adv.name));
            });

            const jumpedNames = jumpedParents
              .map(pid => plannedAfter.find(p => p.id === pid))
              .filter(Boolean).map(p => p.name);
            if (jumpedNames.length){
              const list = jumpedNames.join(", ");
              sendToPDsAuto(adv.pd, oneLineSwapAdvanceMsg(list));
            }
          }
        }

        localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
        renderAll();
        saveNowAuto();
      });
    } else if(handle){ handle.style.visibility='hidden'; }

    if(canEdit()){
      const commit = ()=>{ localStorage.setItem('sched:tasks', JSON.stringify(state.tasks)); renderAll(); saveNowAuto(); };
      const iIdx = state.tasks.findIndex(x=>x.id===t.id);
      if(nameInput){ nameInput.addEventListener('change', ()=>{ state.tasks[iIdx].name = nameInput.value.trim() || 'Untitled'; commit(); }); }
      if(pdInput){ pdInput.addEventListener('change', ()=>{ state.tasks[iIdx].pd = pdInput.value.trim(); commit(); }); }
      if(workTypeSel){
        workTypeSel.addEventListener('change', ()=>{
          const val = workTypeSel.value;
          state.tasks[iIdx].workType = val;
          state.tasks[iIdx].parallel = (val==='ê°„ë‹¨ìˆ˜ì •');
          if(val!=='ê°„ë‹¨ìˆ˜ì •'){ state.tasks[iIdx].group = null; }
          commit();
        });
      }
    }

    rowsEl.appendChild(row);
  });

  renderCalendar(planned, state.owner, progressingId);
  
  
}

/* =========================
 * í˜ì´ì§€ ì´ë²¤íŠ¸/ì´ˆê¸° ë¡œë“œ
 * ========================= */
document.addEventListener('DOMContentLoaded', ()=>{
  if (__read_ONLY__) {
    document.querySelectorAll('input, select, textarea, button').forEach(el => el.disabled = true);
    const addBtn = document.getElementById('addBtn'); if(addBtn) addBtn.style.display='none';
    const saveBtn = document.getElementById('saveBtn'); if(saveBtn) saveBtn.style.display='none';
    setStatus('ì½ê¸° ì „ìš©(ì €ì¥ ì•ˆ í•¨)');
  } else {
    setStatus('ìˆ˜ë™ ì €ì¥ ëª¨ë“œ');
    const sb = document.getElementById('saveBtn');
    if (sb) sb.addEventListener('click', saveNow);
  }
}, {passive:true});

window.addEventListener('resize', debounce(()=> renderAll(), 150));

document.getElementById('ownerSel').addEventListener('change', (e)=>{
  const v=e.target.value;
  if(v==='__add__'){
    setTimeout(()=>{ $('#ownerSel').value = state.owner; },0);
    const name=(prompt('ì¶”ê°€í•  ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:')||'').trim();
    if(!name) return;
    if(state.owners.includes(name)){ alert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤.'); return; }
    state.owners.push(name);
    state.startByOwner[name]=getRealTodayISO();  // âœ… ì‹¤ì œ ì˜¤ëŠ˜
    state.owner=name;
    localStorage.setItem('sched:owners', JSON.stringify(state.owners));
    localStorage.setItem('sched:startByOwner', JSON.stringify(state.startByOwner));
    localStorage.setItem('sched:owner', state.owner);
    renderAll(); saveNowAuto();
    return;
  }
  if(v==='__delete__'){
    setTimeout(()=>{ $('#ownerSel').value = state.owner; },0);
    if(!state.owners.length){ alert('ì‚­ì œí•  ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
    const target=prompt('ì‚­ì œí•  ì‚¬ìš©ì ì´ë¦„ì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”:');
    if(!target) return;
    if(!state.owners.includes(target)){ alert('í•´ë‹¹ ì‚¬ìš©ìê°€ ëª©ë¡ì— ì—†ìŠµë‹ˆë‹¤.'); return; }
    const hasTasks=state.tasks.some(t=>t.owner===target);
    if(hasTasks && !confirm(`"${target}" ì‚¬ìš©ìì— í• ë‹¹ëœ ì‘ì—…ì´ ìˆìŠµë‹ˆë‹¤.\nëª¨ë‘ ì‚­ì œí•˜ê³  ì‚¬ìš©ìë¥¼ ì œê±°í• ê¹Œìš”?`)) return;
    if(hasTasks){ state.tasks=state.tasks.filter(t=>t.owner!==target); }
    state.reports = state.reports.filter(r=>r.owner!==target);
    state.holds = state.holds.filter(h=>h.owner!==target);
    delete state.startByOwner[target];
    state.owners=state.owners.filter(o=>o!==target);
    if(state.owner===target) state.owner=state.owners[0]||'';
    localStorage.setItem('sched:owners', JSON.stringify(state.owners));
    localStorage.setItem('sched:owner', state.owner);
    localStorage.setItem('sched:startByOwner', JSON.stringify(state.startByOwner));
    localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
    localStorage.setItem('sched:reports', JSON.stringify(state.reports));
    localStorage.setItem('sched:holds', JSON.stringify(state.holds));
    renderAll(); saveNowAuto();
    return;
  }
  state.owner=v; localStorage.setItem('sched:owner', state.owner); renderAll();
});

// ì‹œì‘ì¼ UI(í‘œì‹œë§Œ)
document.getElementById('startDate').addEventListener('change', ()=>{ /* disabled */ });

// ì‘ì—… ì¶”ê°€
document.getElementById('addBtn').addEventListener('click', ()=>{
  if(!canEdit()){ alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ë¨¼ì € í•´ì œí•˜ì„¸ìš”.'); return; }

  // âœ… ìƒˆ ì‘ì—… ì¶”ê°€ ì§ì „ì— ê¸°ì¤€ì¼ì„ "ì‹¤ì œ ì˜¤ëŠ˜"ë¡œ ë³´ì •(PC ë‚ ì§œ ë³€ê²½ í›„ ë³µê·€ ì´ìŠˆ ë°©ì§€)
  ensureBaselineToday(state.owner);

  const name=$('#taskName').value.trim();
  const pd=$('#taskPD').value.trim();
  const typ=$('#taskType').value;
  const planned=$('#taskPlanned').checked;
  let dur=parseInt($('#taskDur').value,10);
  if(!name || !(dur>0)) return;

  const newTask = {
    id:uid(), owner:state.owner, name, duration:dur, extraDays:0, pd,
    workType: typ, parallel: (typ==='ê°„ë‹¨ìˆ˜ì •'), group:null,
    planned:planned, inProgress:false, completed:false,
    startedAt:null, completedAt:null,
    spentDays:0, activeSinceISO:null
  };
  state.tasks.push(newTask);

  $('#taskName').value=''; $('#taskPD').value=''; $('#taskDur').value=1; $('#taskType').value='NEW'; $('#taskPlanned').checked=false;

  localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
  renderAll(); saveNowAuto();

  if(planned){
    alert('ì˜ˆì •ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. í–‰ì˜ "ì‘ì—…ì‹œì‘" ë²„íŠ¼ìœ¼ë¡œ ì‹œì‘ì¼ì„ ì„¤ì •í•˜ì„¸ìš”.');
  }
});

/* =========================
 * ì´ˆê¸° ë¡œë“œ
 * ========================= */
async function loadFromJSONBinAndRender(){
  try{
    const data = await jsonbinGet();
    if (Array.isArray(data.owners) && data.owners.length){ state.owners = data.owners.slice(); }
    else {
      const inferred = new Set(state.owners);
      if (Array.isArray(data.tasks)) data.tasks.forEach(t=> inferred.add(t.owner||'ê¹€ì •ìš©'));
      state.owners = Array.from(inferred);
    }

    if (data.startByOwner && typeof data.startByOwner==='object'){
      const merged={}; state.owners.forEach(o=> merged[o]=data.startByOwner[o]||getRealTodayISO()); // âœ… ì‹¤ì œ ì˜¤ëŠ˜
      state.startByOwner=merged;
    }

    if (Array.isArray(data.tasks)){
      state.tasks = data.tasks.map(t=>{
        const workType = t.workType || (t.parallel ? 'ê°„ë‹¨ìˆ˜ì •' : 'NEW');
        return {
          id: t.id||uid(),
          owner: t.owner||'ê¹€ì •ìš©',
          name: t.name||'Untitled',
          duration: t.duration>0?t.duration:1,
          extraDays: Number.isFinite(t.extraDays)? t.extraDays : 0,
          pd: t.pd||'',
          workType,
          parallel: workType==='ê°„ë‹¨ìˆ˜ì •',
          group: (workType==='ê°„ë‹¨ìˆ˜ì •') ? (t.group||null) : null,
          planned: !!t.planned,
          inProgress: !!t.inProgress,
          completed: !!t.completed,
          startedAt: t.startedAt||null,
          completedAt: t.completedAt||null,
          spentDays: Number.isFinite(t.spentDays) ? t.spentDays : 0,
          activeSinceISO: t.activeSinceISO || null
        };
      });
    }

    if (Array.isArray(data.reports)){ state.reports = data.reports.map(r=> ({ ...r, id: r.id || uid() })); }
    if (Array.isArray(data.holds)){ state.holds = data.holds; }

    lastSavedJSON = JSON.stringify({ owners:state.owners, startByOwner:state.startByOwner, tasks:state.tasks, reports:state.reports, holds:state.holds });
    localStorage.setItem('sched:owners', JSON.stringify(state.owners));
    localStorage.setItem('sched:owner', state.owner);
    localStorage.setItem('sched:startByOwner', JSON.stringify(state.startByOwner));
    localStorage.setItem('sched:tasks', JSON.stringify(state.tasks));
    localStorage.setItem('sched:reports', JSON.stringify(state.reports));
    localStorage.setItem('sched:holds', JSON.stringify(state.holds));
    if(CAN_EDIT) setStatus('ì €ì¥ë¨');
  }catch(e){
    setStatus(CAN_EDIT ? 'ì˜¤í”„ë¼ì¸(ë¡œì»¬)' : 'ì½ê¸° ì „ìš©(ì €ì¥ ì•ˆ í•¨)');
  }
  renderAll();
}

// ê¸°ì¤€ì¼ ìœ ì§€ + UIëŠ” 'ì˜¤ëŠ˜'(TEST ë°˜ì˜) ê³ ì • í‘œì‹œ
function renderAll(){
  renderOwnerDropdown();
  const sd = $('#startDate');
  if (sd){ sd.value = getTodayISO(); sd.setAttribute('disabled', 'disabled'); }
  refreshPassUI();
  renderReports();
  renderTable();
}

function refreshPassUI(){
  const badge=$('#lockBadge'), passBtn=$('#passBtn'), passOffBtn=$('#passOffBtn'), passInput=$('#editPass');
  if(PASS_OK){
    badge.textContent='í•´ì œ'; badge.className='badge-unlock';
    passBtn.style.display='none'; passOffBtn.style.display='inline-block'; passInput.disabled=true;
  } else {
    badge.textContent='ì ê¸ˆ'; badge.className='badge-lock';
    passBtn.style.display='inline-block'; passOffBtn.style.display='none'; passInput.disabled=false;
  }
  document.querySelectorAll('.add-task-form input, .add-task-form button, .add-task-form select')
    .forEach(el=>{ el.disabled = !canEdit(); });

  const reportsCard = document.getElementById('reportsCard');
  if (reportsCard){ reportsCard.style.display = PASS_OK ? '' : 'none'; }
}

document.getElementById('passBtn').addEventListener('click', ()=>{
  if(!CAN_EDIT){ alert('ì½ê¸° ì „ìš©ì…ë‹ˆë‹¤.'); return; }
  const v=($('#editPass').value||'').trim();
  if(!v){ alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  if(v===PASS_VALUE){ PASS_OK=true; refreshPassUI(); renderAll(); } else { alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
});
document.getElementById('passOffBtn').addEventListener('click', ()=>{
  PASS_OK=false; $('#editPass').value=''; refreshPassUI(); renderAll();
});

loadFromJSONBinAndRender();
</script>
</body>
</html>
